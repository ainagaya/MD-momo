% !TeX spellcheck = ca
% TIPUS DE DOCUMENT
\documentclass[a4paper,10pt]{article} 
% Permet canviar la mida del paper, la mida de la lletra...

% GEOMETRIA
%\usepackage[a4paper,bindingoffset=0.2in,%
%left=3cm,right=3cm,top=2.5cm,bottom=2.5cm,%
%footskip=.25in]{geometry} % Marges normals

\usepackage[a4paper,bindingoffset=0.2in,%
left=1in,right=1in,top=1in,bottom=1in,%
footskip=.25in]{geometry} % Marges estrets

% IDIOMA 
%\usepackage[catalan]{babel} %Fa que l'idioma del document sigui en catal√† (p.ex. escriur√† "Resum" enlloc de "Abstract")
\usepackage[english]{babel} %Fa que l'idioma del document sigui l'angl√®s

% ENCODING
\usepackage{cmap,lmodern}  % √ötil tenir-ho sempre.
\usepackage[T1]{fontenc} % Millora els car√†cters del pdf que es produeix
\usepackage[utf8]{inputenc} % Evita problemes amb qu√® LaTeX no s√†piga llegir certs car√†cters.
\usepackage{hyperref} % Permet que els links siguin clicables en lectors pdf

% IMATGES
% \usepackage{wrapfig,graphicx} % Permet afegir imatges
%\graphicspath{{Imatges/} % Si volem guardar totes les imatges en una carpeta (+ c√≤mode)
\usepackage[font=small]{caption} % Peus de foto
% \usepackage{subcaption} % Subpeus de foto
% \usepackage{tikz}
% \usepackage{float}
% \usepackage{pgfplots}
% \usepackage{multirow}
\usepackage[labelfont=bf]{caption}
\usepackage{fancyhdr}
\usepackage{bm}
\usepackage{hyperref}
\usepackage{graphicx}
% \usepackage{gensymb}
\usepackage{amsmath}
\usepackage{amssymb}
% \usepackage{siunitx}
\usepackage{parskip}
% \usepackage{blindtext}
\usepackage{graphicx}
\usepackage[utf8]{inputenc}
% \usepackage{multirow}
\usepackage{longtable}
\usepackage{fancyvrb}
\usepackage{xcolor}
\usepackage{subcaption}
\usepackage{wrapfig}
\usepackage{fancyhdr}
\usepackage{listings}
\usepackage{color}
\usepackage{siunitx}
	
% EQUACIONS
% \usepackage{mathtools,amsmath,amssymb,systeme,braket} % Diverses eines d'equacions
	
% OTROS
\setlength{\parindent}{0em}   % Controla la indentaci√≥ de la primera l√≠nia de cada par√†graf
%\setlength{\parskip}{0.3em}   % Controla la mida de 'espaiat entre par√†grafs
%\usepackage{enumitem} %Permet el control sobre llistes
%\setlist{noitemsep,nolistsep} % Controla l'espaiat entre elements de llista (requereix el paquet enumitem)
	
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{frame=tb,
	language=Fortran,
	aboveskip=3mm,
	belowskip=3mm,
	showstringspaces=false,
	columns=flexible,
	basicstyle={\small\ttfamily},
	numbers=none,
	numberstyle=\tiny\color{gray},
	keywordstyle=\color{blue},
	commentstyle=\color{dkgreen},
	stringstyle=\color{mauve},
	breaklines=true,
	breakatwhitespace=true
	tabsize=3
}	
	
\usepackage{fancyhdr}
\usepackage{tcolorbox}% TIPUS DE DOCUMENT
	
\pagestyle{fancy}
\fancyhf{}
\rhead{Aina Gaya}
\lhead{Pr√†ctiques de models QM i MM}
\cfoot{\thepage}
	%
	%opening
\title{\textsc{{\large Molecular modelling } \\ Analysis of properties of a Lennard-Jones liquid } \\  {\small Molecular Dynamics}}
\author{Aina Gaya √Ävila \\ {\small Lecturer: Carles Calero }}
	
\begin{document}
		
\maketitle

\begin{abstract}
	S'efectuen simulacions de din√†mica molecular en un sistema de 125 part√≠cules interactuant a trav√©s d'un potencial de Lennard-Jones. S'apliquen condicions peri√≤diques de contorn per simular un sistema infinit. En primer lloc, s'efectuen simulacions en un sistema a√Øllat emprant els integradors de Verlet i d'Euler. La densitat del sistema es fixa a $\rho' = 0.7$ La temperatura d'equilibri redu√Øda obtinguda √©s $T' = 85.33$. Es pot veure con Euler √©s m√©s inestable. A continuaci√≥ s'efectuen simulacions fixant la temperatura amb un term√≤stat Andersen. Es varia la densitat i s'observa una transici√≥ de fase. 
\end{abstract}

\section{Introducci√≥: Simulacions de din√†mica molecular}
El model microsc√≤pic m√©s senzill per simular una subst√†ncia capa√ß d'existir tant en estat s√≤lid, l√≠quid com gas√≥s est√† basat en part√≠cules esf√®riques que interactuen entre elles. Aquesta interacci√≥ es modelitza tenint en compte dues caracter√≠stiques:
\begin{itemize}
	\item La resist√®ncia a la compressi√≥, √©s a dir, que cada part√≠cula ocupa el seu espai i a curt abast la interacci√≥ √©s repulsiva. √âs el principi d'exclusi√≥ de Pauli.
	\item Les forces de Van der Waals entre √†toms als estats s√≤lid i l√≠quid, que tendeixen a apropar les part√≠cules.
\end{itemize}

El potencial m√©s emprat per simular el descrit anteriorment √©s el de Lennard-Jones. Per descriure el potencial entre dues particules $i$ i $j$, localitzades a $r_i$ i $r_j$, pren la forma seg√ºent:

$$ u(r_{ij}) = 4 \epsilon \left[ \left( \frac{\sigma}{r_{ij}}\right)^{12} - \left( \frac{\sigma}{r_{ij}}\right)^{6} \right] $$

On 

\begin{itemize}
	\item $r_{ij} = | r_i - r_j | $ √©s la dist√†ncia entre part√≠cules.
	\item $\sigma$ defineix la mida de la part√≠cula.
	\item $\epsilon$ √©s la profunditat del potencial. √âs una mesura de la magnitud de la interacci√≥.
\end{itemize}

L'objectiu d'aquest projecte √©s dur a terme una simulaci√≥ d'un l√≠quid de Lennard-Jones per estudiar-ne les seves propietats. A cada pas de temps es calcular√† la magnitud i la direcci√≥ de la interacci√≥ entre les part√≠cules i es far√† evolucionar el sistema en funci√≥ d'aquestes. L'hamiltoni√† del sistema ser√†:

\begin{equation}
	\mathcal{H} = \sum_{i}^{N} \frac{p_i}{2 m_i} + U(r_1, r_2, ..., r_N)
\end{equation}

El primer terme correspon a l'energia cin√®tica, i el segon a l'energia potencial. En el segon terme es tenen en compte tant els efectes d'un camp extern (inexistent en el nostre cas) com l'efecte de les interaccions entre les part√≠cules. En aquesta pr√†ctica nom√©s es tindran en compte les interaccions entre parelles de part√≠cules, i aquestes vindran descrites pel potencial de Lennard-Jones. Les interaccions entre tres, quatre, o m√©s part√≠cules s√≥n m√©s costoses de calcular i la seva contribuci√≥ √©s menys rellevant. 

\begin{figure}
	\centering
	\includegraphics[width=0.7\linewidth]{lennard-jones_potential}
	\caption{Potencial de Lennard-Jones.}
	\label{fig:lennard-jonespotential}
\end{figure}


%(a) Describe in detail the different parts of the code. 


% How do you initialize the system of particles (and set the density)? 
Estudiarem un sistema de $N=125$ part√≠cules. L'altre par√†metres que definir√† el sistema ser√† la densitat. Totes les simulacions estan dutes a terme amb Fortran90, i la part de processament de dades s'ha fet combinant Python, Gnuplot i Bash

El sistema √©s inicialitzat emprant una estructura c√∫bica simple (SC), i per tant, en podem calcular el volum $V$ i la llargada de cada un dels costats $L$ i la dist√†ncia entre part√≠cules $a$:

$$ V = \frac{N}{\rho} \qquad L = V^{1/3} \qquad a = \frac{L}{N^{1/3}} $$

Sabent la dist√†ncia entre part√≠cules, inicialitzem el sistema amb la subrutina que es troba a \ref{annex:inicialitzacio}, que situa les part√≠cules de manera que formin una estructura SC.

% What integrator do you use?
\subsection{Integradors}
L'integrador que emprarem per solucionar les equacions de Newton que regeixen aquest sistem√† ser√†, principalment, el \textit{velocity Verlet}. La implementaci√≥ d'aquest algoritme √©s la seg√ºent:

\begin{itemize}
	\item Es disposa de les posicions i les velocitats de les part√≠cules, que han estat calculades al pas anterior (o s'empren les condicions inicials si √©s el primer pas de temps).
	\item Es calcula la for√ßa $f$ sobre cada part√≠cula.
	\item Es calcula la posici√≥ emprant la velocitat: $r (t + \Delta t) = r(t) + v(t) \Delta t + \frac{f(t)}{2m}\Delta t ^2$.
	\item Es calcula  la for√ßa sobre cada part√≠cula a $t + \Delta t$ emprant la nova distribuci√≥ de part√≠cules. 
	
	\item Es calcula la velocitat a $t + \Delta t$: $v(t+\Delta t) = v(t) + \frac{f(t) + f(t + \Delta t)}{2m} \Delta t$.

\end{itemize}

El compararem tamb√© amb el m√®tode d'Euler, que a cada pas de temps calcula les posicions i les velocitats de manera expl√≠cita:
\begin{equation}
	r_i (t+\Delta t) = r_i(t) + v_i(t) \Delta t + \frac{f_i(t)}{2m_i}\Delta t^2 \qquad v_i (t + \Delta t) = v_i (t) + \frac{f_i(t)}{m_i} \Delta t
\end{equation}

\subsection{Condicions peri√≤diques de contorn}
%  How do you implement periodic boundary conditions? 
Per simular que estem tractant un sistema major (infinit) cal implementar condicions peri√≤diques de contorn. Aix√≤ genera infinites c√≤pies de les nostres part√≠cules i elimina l'efecte de les parets. La implementaci√≥ es troba a \ref{annex:pbc}. √âs important mencionar que les condicions peri√≤diques de contorn condicionen el pas temporal ($\Delta t$) que podem emprar. Posem per exemple dues part√≠cules molt properes que s'estan repel¬∑lint. El despla√ßament provocat per la for√ßa repulsiva que exerceix cada una sobre l'altre √©s proporcional a $f_i \delta t^2$. Cal evitar que aquest despla√ßament sigui massa gran ja que si  sobrepassa $L/4$, degut a les condicions peri√≤diques de contorn, en el seg√ºent pas de temps es trobarien m√©s a prop del que estaven, i aix√≤ comporta inestabilitats.

% How do you control the temperature (how do you implement the thermostat)? 
\subsection{Control de la temperatura}
Inicialitzarem el sistema partint d'una estructura c√∫bica simple en la qual la velocitat de cada part√≠cula seguir√† una distribuci√≥ bimodal (amb dos pics) que correspongui a una temperatura redu√Øda $T' = 100 $. Com que la temperatura instant√†nia $T_{inst}$, del principi d'equipartici√≥, √©s:

\begin{equation}
	T_{inst} = \frac{2}{N_f k_b} K_e
\end{equation}

Tenint en compte que l'energia cin√®tica √©s $K_e = \frac{1}{2} m v^2$, podem veure que la velocitat de les part√≠cules a una temperatura instant√†nia fixa √©s:

$$ v^2 = \frac{T N_f k_b}{m} \to v_i = \pm \sqrt{\frac{T k_b}{m}}  $$

Aleshores, per inicialitzar el sistema, assignarem aleat√≤riament $v_{+}$ o $v_{-}$ a cada component de cada part√≠cula.

Per simular un sistema que pertanyi a la col¬∑lectivitat can√≤nica (nombre de part√≠cules, volum i temperatura determinats) s'empra un term√≤stat Andersen. Aquest term√≤stat s'empra molt en din√†mica molecular. Consisteix en reassignar, amb una certa probabilitat, la velocitat d'una part√≠cula seguint una distribuci√≥ gaussiana, centrada la temperatura a la qual es vol mantenir el sistema. Per generar aquests nombres aleatoris s'empra un generador Box-M√ºller.

% What units do you use for the Lennard-Jones interactions? 
\subsection{Unitats redu√Ødes}
Per evitar treballar amb nombres molt grans o molt petits, que podrien estar fora del rang depenent de la precisi√≥ amb la que es treballi, es defineixen les unitats redu√Ødes. A m√©s, aix√≤ simplifica substancialment les equacions, ja que els par√†metres que defineixen el model s√≥n absorbides per les unitats. Emper√≤, el motiu principal per definir les unitats redu√Ødes √©s que un sol model √©s capa√ß de descriure m√∫ltiples problemes, ja que les propietats que es dedueixen emprant les unitats arbitr√†ries es poden escalar a les unitats f√≠siques apropiades per cada un dels problemes. Per problemes de Lennard-Jones s'escullen respectivament $\sigma$, $m$ i $\varepsilon$ com a unitats de longitud, massa i energia.

La dist√†ncia redu√Øda ser√† aleshores $r' = r/\sigma$, l'energia $u' = u/\varepsilon$, la massa $m' = 1$. D'aquestes se'n pot derivar el temps:

$$ [F] = [m][a] \to \frac{[E]}{[r]} = [m]\frac{[r]}{[t]^2} \to [t] = \frac{1}{[r]}\sqrt{\frac{[E]}{[m]}} \to t' =  \frac{t}{\sigma}\sqrt{\frac{\epsilon}{m}} $$ 

La temperatura:

$$ k_B = \frac{[E]}{[T]} \to T' = T \frac{k_B}{\epsilon} $$

La densitat:

\begin{equation}
	[\rho] = \frac{[m]}{[V]} \to \rho' = \rho \frac{\sigma^3}{m}
\end{equation} 

I la pressi√≥:

\begin{equation}
	[P] = \frac{[F]}{[r]^2} = \frac{[E]/[r]}{[r]^2} = \frac{\varepsilon}{\sigma^3} \to P' = P \frac{\sigma^3}{\varepsilon}
\end{equation}



% What cut-off do you use for the interactions (and why)? 
\subsection{Optimizacions: \textit{cutoff} i truncaci√≥}
Com que estem treballant amb condicions peri√≤diques de contorn cada part√≠cula pot interactuar amb infinites part√≠cules, ja que hi ha infinites imatges de cada part√≠cula. Per evitar aquesta suma infinita i a m√©s optimitzar els c√†lculs computacionals, nom√©s es calculen les forces entre les part√≠cules que estan a menor dist√†ncia que una dist√†ncia que anomenarem \textit{cutoff} ($r_c$). Definirem $r_c' = 2.5$ ja que com es pot veure a la figura \ref{fig:lennard-jonespotential}, a dist√†ncies majors la contribuci√≥ √©s gaireb√© nul¬∑la. El potencial doncs seria:

$$ u^{cut}(r) = \left\{ \begin{array}{lcc} u^{LJ}(r), & \text{if } r \leq r_c \\ 0,  & \text{if } < r_c  \end{array} \right.$$

Aquesta truncaci√≥ d√≥na lloc a un salt discontinuu, que d√≥na problemes en calcular les forces derivades d'aquest potencial. √âs per aquest motiu que el potencial escollit per la nostra simulaci√≥ fa servir tant un \textit{cutoff} com un \textit{shift}, que porta a un potencial continuu: 

\begin{equation}
	u^{cut}(r) = \left\{ \begin{array}{lcc} u^{LJ}(r) - u^{LJ}(r_c), & \text{if } r \leq r_c \\ 0,  & \text{if } < r_c  \end{array} \right.
\end{equation}	

\section{Simulaci√≥ d'un sistema a√Øllat}
Per comprovar que la f√≠sica del sistema del sistema que estem descrivint √©s consistent, en primer lloc durem a terme una simulaci√≥ d'un sistema a√Øllat, que no est√† en contacte amb un bany t√®rmic. Situarem 125 part√≠cules en una estructura c√∫bica simple (5x5x5) amb una distribuci√≥ de velocitats bimodal compatible amb una temperatura instantania $T'=100$. Emprem  $\rho = 0.7 m\sigma^3$. Hem estudiat el comportament del sistema al llarg de $t' = 1$ fent servir diferents passos de temps: $\Delta t = 10^{-3}$, $\Delta t = 10^{-4}$ i $\Delta t = 10^{-5}$. Per intervals majors s'han trobat inestabilitats i vist que la conservaci√≥ de l'energia es compleix en aquesta escala, no s'han considerat intervals menors, ja que s√≥n m√©s costosos computacionalment. 

\subsection{Conservaci√≥ de l'energia}

Els resultats obtinguts per diferents passos de temps per l'integrador de velocity Verlet es mostra a la figura \ref{fig:energyverlet}. En tots ells s'observa que l'energia del sistema es conserva. Tamb√© es veu com el sistema s'equilibra en els primers instants, ja que l'energia potencial augmenta i la cin√®tica disminueix. Aix√≤ succeeix perqu√® les part√≠cules, que inicialment tenien la velocitat corresponent a $T'=100$, son parcialment frenades per la interacci√≥ de Lennard-Jones. Un cop s'equilibra el sistema, hi ha oscil¬∑lacions a l'energia potencial i a la cin√®tica per√≤ l'energia total es mant√© constant. 

\begin{figure}
	\centering
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{energy_verlet_1}
		\caption{$\Delta t = 10^{-3}$}
		\label{fig:energyverlet1}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{energy_verlet_2}
		\caption{$\Delta t = 10^{-4}$}
		\label{fig:energyverlet2}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		% CHANGE THIS!!!
		\includegraphics[width=\linewidth]{energy_verlet_3} 
		\caption{$\Delta t = 10^{-5}$}
		\label{fig:energyverlet3}
	\end{subfigure}
	\caption{Energia potencial, cin√®tica i total en una simulaci√≥ on s'empra l'integrador velocity Verlet, per diversos passos de temps.}
	\label{fig:energyverlet}
\end{figure}

Per l'integrador Euler s'han fet servir els mateixos passos de temps, per√≤ s'ha integrat en un interval menor, que per \textit{velocity Verlet} ha estat suficnet per equilibrar el sistema. Els resultats es poden veure a \ref{fig:energyeuler}. Pel pas de temps m√©s gran a \ref{fig:energyeuler1} podem veure com l'energia del sistema no es conserva i va augmentant. Amb el pas un ordre de magnitud menor la situaci√≥ millora, per√≤ l'energia total segueix augmentant. Pel darrer pas de temps que hem estudiat el sistema sembla m√©s estable i l'energia es conserva.

\begin{figure}
	\centering
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{energy_euler_1}
		\caption{$\Delta t = 10^{-3}$}
		\label{fig:energyeuler1}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{energy_euler_2}
		\caption{$\Delta t = 10^{-4}$}
		\label{fig:energyeuler2}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{energy_euler_3} 
		\caption{$\Delta t = 10^{-5}$}
		\label{fig:energyeuler3}
	\end{subfigure}
	\caption{Energia potencial, cin√®tica i total en una simulaci√≥ on s'empra l'integrador d'Euler, per diversos passos de temps.}
	\label{fig:energyeuler}
\end{figure}

\subsection{Conservaci√≥ del moment}

A les figures \ref{fig:momentumverlet} i \ref{fig:momentumeuler} podem veure l'evoluci√≥ del moment durant la simulaci√≥. Les oscil¬∑lacions per ambd√≥s integradors s√≥n a ordres molt petits i per tant s√≥n menyspreables. Podem afirmar que en les simulacions dutes a terme el moment es conserva.

\begin{figure}[h]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_verlet_1}
		\caption{$\Delta t = 10^{-3}$}
		\label{fig:momentumverlet1}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_verlet_2}
		\caption{$\Delta t = 10^{-4}$}
		\label{fig:momentumverlet2}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_verlet_3} 
		\caption{$\Delta t = 10^{-5}$}
		\label{fig:momentumverlet3}
	\end{subfigure}
	\caption{Moment total en simulaci√≥ on s'empra l'integrador velocity Verlet, per diversos passos de temps. El moment es considera constant, ja que s'ha d'anar a escales molt petites per veure'n les oscil¬∑lacions.}
	\label{fig:momentumverlet}
\end{figure}

\begin{figure}[h]
	\centering
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_euler_1}
		\caption{$\Delta t = 10^{-3}$}
		\label{fig:momentumeuler1}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_euler_2}
		\caption{$\Delta t = 10^{-4}$}
		\label{fig:momentumeuler2}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{momentum_euler_3} 
		\caption{$\Delta t = 10^{-5}$}
		\label{fig:momentumeuler3}
	\end{subfigure}
	\caption{Moment total en simulaci√≥ on s'empra l'integrador Euler, per diversos passos de temps. El moment es considera constant, ja que s'ha d'anar a escales molt petites per veure'n les oscil¬∑lacions.}
	\label{fig:momentumeuler}
\end{figure}

\subsection{Distribuci√≥ de velocitats}

La distribuci√≥ inicial de velocitats que s'ha emprat a totes les simulacions √©s la mateixa (s'ha calculat a l'inici del programa principal i s'ha guardat per ser emprada pels dos integradors, i en els diversos passos de temps) i es pot veure a la figura \ref{fig:ini_vel}. Veiem com totes les components de la velocitat s√≥n $v = \pm \sqrt{T'} = 10$. Aquesta distribuci√≥ evoluciona amb el temps per acabar donant, al final de la simulaci√≥, els resultats que es veuen a \ref{fig:fin_vel_verlet}. La temperatura final del sistema √©s $T' = 85.33 \pm 0.02 $, promitjant per les darreres 1000 configuracions. 


\begin{figure}
	\centering
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{ini_vel_x}
		\caption{Eix x}
		\label{fig:ini_vel_x}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{ini_vel_y}
		\caption{Eix y}
		\label{fig:ini_vel_y}
	\end{subfigure}
	\begin{subfigure}{0.3\linewidth}
		\includegraphics[width=\linewidth]{ini_vel_z} 
		\caption{Eix z}
		\label{fig:ini_vel_z}
	\end{subfigure}
	\caption{Distribuci√≥ inicial de velocitats, per components.}
	\label{fig:ini_vel}
\end{figure}

Un cop equilibrat el sistema la distribuci√≥ de velocitats hauria de ser similar a una distribuci√≥ de Maxwell-Boltzmann. Tot i que aquest resultat prov√© de la teoria cin√®tica dels gasos i per tant s'aplica a gasos ideals cl√†ssics, tamb√© es pot aplicar a gasos reals en temperatures ordin√†ries amb bons resultats \cite{StadPhys}. 

La distribuci√≥ de Maxwell-Boltzmann √©s la seg√ºent:

\begin{equation}
	f(v) = \left[\frac{m}{2\pi k_b T}\right]^{3/2} 4\pi v^2 \exp\left(-\frac{mv^2}{2k_B T} \right)
\end{equation}

I per components:

\begin{equation}
	f(v_i) dv_i = \left[\frac{m}{2\pi k_b T}\right]^{1/2}  \exp\left(-\frac{mv_i^2}{2k_B T} \right) dv_i
\end{equation}

Veiem a la figura \ref{fig:fin_vel_verlet} com els nostres resultats concorden prou b√© amb la teoria. L'histograma s'ha fet realitzant un promig dels 1000 darreres passos de temps. El sistema doncs s'ha desendre√ßat i ja no tenim una c√∫bica simple sin√≥ un sistema gas√≥s.

\begin{figure}
	\centering
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{fin_vel_x_verlet}
		\caption{Eix x}
		\label{fig:fin_vel_x_verlet}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{fin_vel_y_verlet}
		\caption{Eix y}
		\label{fig:fin_vel_y_verlet}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}
		\includegraphics[width=\linewidth]{fin_vel_z_verlet} 
		\caption{Eix z}
		\label{fig:fin_vel_z_verlet}
	\end{subfigure}
	\begin{subfigure}{0.45\linewidth}	
		\includegraphics[width=\linewidth]{fin_vel_module_verlet} 
		\caption{M√≤dul de la velocitat}
		\label{fig:fin_vel_module_verlet}
	\end{subfigure}
	\caption{Distribuci√≥ final de velocitats, per components, ajustant una corba proporcional a la distribuci√≥ de Maxwell-Boltzmann. Veiem que les nostres velocitats segueixen prou b√© la distribuci√≥.}
	\label{fig:fin_vel_verlet}
\end{figure}

\section{An√†lisi de les propietats d'un l√≠quid de Lennard-Jones}
En aquesta secci√≥ s'estudia la interacci√≥ entre √†toms d'Arg√≥. Aquests tenen $\epsilon = 0.998$ kJ/mol i $\sigma = 3.4 \si{\angstrom}$.


% Calculate the kinetic, potential and total energy per particle of a system of (N > 100) argon atoms in a fluid state with densities œÅ = 0.05, 0.1, 0.2, 0.4, 0.6, 0.8m/œÉ 3 and a fixed temperature (using a thermal bath) kB T = 1.2.

% ‚Ä¢ Plot a graph with the kinetic, potential and total energy as a function of density. Show your results in units of kJ/mol for the energies and g/cm3 for the density. How do you equilibrate your system? How many timesteps do you use to calculate your results?



\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{pot_energy_density}
	\caption{Promig de l'energia ci√®tica, potencial i total per diferents valors de la densitat, a temperatura fixa.}
	\label{fig:energyvsrho}
\end{figure}

Per fer-ho, s'ha inicialitzat el sistema de la mateixa manera que abans, amb una c√∫bica simple. Per desendre√ßar (fondre) el sistema, s'ha acoblat el sistema a un term√≤stat Andersen a $T' = 100$, i s'han dut a terme 10000 passos amb $\Delta t = 10^{-4}$ . A continuaci√≥ s'ha rebaixat la temperatura a $T=1.2$ i s'han dut a terme 150.000 passos de producci√≥. Aquest proc√©s s'ha dut a terme pels seg√ºents valors de la densitat: $\rho' = 0.05, 0.1, 0.2, 0.4, 0.6, 0.8 $.


Tot fent √∫s del m√®tode de Block Average, s'han calculat l'energia cin√®tica, la potencial i la total del sistema. Els resultats obtingut es troben a la figura \ref{fig:energyvsrho}. En aquesta s'observa com l'energia cin√®tica del sistema es mant√© constant, ja que sempre estem treballant a la mateixa temperatura. Sabem, de f√≠sica estad√≠stica, que la temperatura √©s un indicador de la velocitat de les part√≠cules en un sistema. Per tant, com que l'energia cin√®tica t√© una estreta relaci√≥ amb la velocitat, aquesta es mant√© constant en augmentar la densitat, ja que la temperatura del sistema no varia. D'altra banda, veiem com l'energia potencial minva amb la temperatura. Ens trobem en un sistema lligat, ja que l'energia potencial √©s negativa, i veiem com amb la densitat va augmentant el valor absolut de l'energia potencial. En augmentar la densitat les part√≠cules seran m√©s properes les unes amb les altres i per tant, l'energia potencial d'interacci√≥ ser√† major. 


Tamb√© s'han calculat la pressi√≥ i la temperatura del sistema. Pel c√†lcul de la pressi√≥ s'ha seguit el cap√≠tol \textit{Simple termodinamical averages} de \cite{allen}. En aquest es defineix la pressi√≥ instant√†nia com:

$$ \mathcal{P} = \rho k_b \mathcal{T} + \frac{\mathcal{W}}{V} \qquad \mathcal{W} = \frac{1}{3} \sum_i \sum_{j<i} r_{ij} f_{ij} $$ 

Aquesta quantitat s'ha acumulat i s'ha calculat fent-ne un promig amb el m√®tode de Block Average, com tota la resta de quantitats termodin√†miques. Encara que es van fer esfor√ßos per aconseguir resultats que es consideressin consistents, per certs valors de la densitat hem obtingut valors negatius de la pressi√≥. S'ha comprovat la bibliografia (\cite{Hess}, \cite{Gregory}, \cite{HansenVerlet}) i s'ha vist que els nostres resultats concorden amb els seus i que per tant, tot i que el raonament f√≠sic escapa el nostre coneixement, sembla ser que els nostres resultats s√≥n acceptables. Cal mencionar que $T'=1.2$, com es pot veure a la figura \ref{fig:screenshot-from-2023-12-17-11-22-54}, per algunes densitats ens trobem a la zona de transici√≥ entre la fase gas i la fase l√≠quida. Hi ha doncs una regi√≥ de coexist√®ncia de les dues fases, ja que √©s una transici√≥ de fase de segon ordre. Els valors estudiants pels quals s'obt√© una pressi√≥ menor que zero s√≥n en aquesta regi√≥ de coexist√®ncia. Aix√≠ doncs, estem davant d'una transici√≥ de fase de gas a l√≠quid. 


\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{preassure}
	\caption{Valors obtinguts de la pressi√≥ a diverses densitats.}
	\label{fig:preassure}
\end{figure}


	\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{"../../../../../Pictures/Screenshots/Screenshot from 2023-12-17 11-11-40"}
	\caption{Font: \cite{Gregory}}
	\label{fig:screenshot-from-2023-12-17-11-11-40}
	\end{figure}

	\begin{figure}
		\centering
		\includegraphics[width=\linewidth]{"../../../../../Pictures/Screenshots/Screenshot from 2023-12-17 11-22-54"}
		\caption{Diagrama de fases d'un flu√Ød de Lennard-Jones. La zona vermella √©s la isoterma que estem explorant.}
		\label{fig:screenshot-from-2023-12-17-11-22-54}
	\end{figure}






% ‚Ä¢ Visualize (part of) the equilibrium trajectory and interpret your observations in terms of the phase diagram of the Lennard-Jones fluid shown in Fig. 1.



% Calculate the pressure of a system of (N > 100) argon atoms at kB T = 1.2 for densities œÅ = 0.05, 0.1, 0.2, 0.4, 0.6, 0.8m/œÉ 3 . Plot your results in Pascal.

\section{Despla√ßament quadr√†tic mitj√†}

El despla√ßament quadr√†tic mitj√† (en angl√®s \textit{mean squared displacement}, MSD) √©s una mesura de la desviaci√≥ de la posici√≥ de les part√≠cules respecte una posici√≥ de refer√®ncia. Representa una mesura quina part de l'espai ha estat recorreguda per una part√≠cula: si una part√≠cula es mou molt, el seu MSD ser√† elevat. En canvi, si una part√≠cula est√† quieta, el seu MSD ser√† nul. Per calcular-lo, s'ha guardat la posici√≥ en la que es troba el sistema en acabar la inicialitzaci√≥, i a cada pas de temps s'ha calculat el MSD. Com amb la resta de mesures, s'ha fet servir la t√®cnica del Block Average. El resultat es mostra a la figura \ref{fig:msd}, on veiem que com era d'esperar, el MSD minva amb la densitat. A densitats baixes, les part√≠cules tenen la capacitat de moure's molt, ja que estan menys lligades. Correspon a un comportament gas√≥s. En canvi, quan la densitat augmenta i el sistema est√† en estat l√≠quid, el despla√ßament quadr√†tic mitj√† √©s molt menor, ja que les part√≠cules estan molt m√©s lligades entre si, i tenen menys llibertat de moviment.


\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{MSD}
	\caption{Despla√ßament quadr√†tic mig en front de la densitat del sistema. }
	\label{fig:msd}
\end{figure}


\begin{figure}
	\centering
	\includegraphics[width=\linewidth]{MSD_evol}
	\caption{Evoluci√≥ del MSD en funci√≥ del temps per la fase gasosa ($\rho' = 0.05$) i la fase l√≠quida ($\rho' = 0.80$).}
	\label{fig:msdevol}
\end{figure}

A la figura \ref{fig:msdevol} es veu l'evoluci√≥ del MSD en funci√≥ del temps. S'ha fet un ajust lineal per obtenir el coeficient de difusi√≥, ja que est√† relacionat amb el coeficient de difusi√≥:

$$ \langle \Delta r(t)^2 \rangle \propto 6Dt $$ 

\begin{table}
	\centering
	\begin{tabular}{|c|c|c|}
		\hline
		$\rho'$ & $6D$ (cm$^2$/s) & $D$ (cm$^2$/s) \\
		\hline
		0.05 &  $(1.40 \pm 0.03) \times 10^{-15}$ & $(2.34 \pm 0.05 )\times 10^{-16}$ \\
		\hline
		0.80 &  $(10.0 \pm 0.9) \times 10^{-17}$ & $(1.66 \pm 0.12) \times 10^{-17}$\\
		\hline
	\end{tabular}
	\caption{Coeficients de difusi√≥ obtinguts per ambdues fases.}
	\label{tab:coeficients}
\end{table}

S'ha fet un ajust lineal de les dades i es relaciona el pendent amb 6t. Els resultats es troben a la taula \ref{tab:coeficients}. A la fase l√≠quida ($\rho = 0.8$) el coeficient de difusi√≥ √©s un ordre de magnitud menor que en el gas√≥s. 








\section{Conclusions}

\section{Annex}

\subsection{Inicialitzaci√≥ de les posicions de les part√≠cules}
\label{annex:inicialitzacio}
\begin{lstlisting}

Subroutine initialize_positions(N, rho, r)
! """"
! Calculates the positions r of N particles in a SC structure
! INPUTS: N, rho
! OUTPUT: r(N, 3)
! """"
	Implicit none
	integer, intent(in) :: N
	real(8), intent(in) :: rho
	real(8), dimension(N, 3), intent(out) :: r
	real(8) :: L, a, x, y, z, ini
	integer :: M, i, j, k, particle

	L = (N/rho)**(1./3.)

	M = N**(1./3.)

	a = L/(M)

	! Set the position of every particle
	particle = 1
	ini = -L/2.d0
	
	do i = 0, M-1
		do j = 0, M-1
			do k = 0, M-1
				x = ini + i*a
				y = ini + j*a
				z = ini + k*a
				r(particle, :) = (/x, y, z/)
				particle = particle + 1
			end do
		end do
	end do
End Subroutine
\end{lstlisting}

\subsection{Condicions peri√≤diques de contorn}
\label{annex:pbc}
\begin{lstlisting}

Subroutine pbc(vector, L, D)
	Implicit none
	integer :: D, i
	real(8), dimension(D), intent(inout) :: vector
	real(8), intent(in) :: L


	do i = 1, D
		if (vector(i).gt.L/2.) then
			vector(i) = vector(i) - L
			if (abs(vector(i)).gt.1000) then
				print*, "YOU HAVE INESTABILITIES!"
				stop 
			end if
		else if (vector(i).lt.(-L/2.)) then
			vector(i) = vector(i) + L
			if (abs(vector(i)).gt.1000) then
				print*, "YOU HAVE INESTABILITIES!"
				stop
			end if
		end if
	end do

Return
End Subroutine	
\end{lstlisting}

\subsection{For√ßa emprant el potencial de Lennard-Jones}

\begin{lstlisting}
	
	Subroutine find_force_LJ(r, N, L, cutoff, F, pot)
		! """"
		! Calculates the forces applied to each particle of the system
		! INPUTS: r, Nm L, cutoff, F
		! OUTPUT: pot, F
		! """"
		Implicit none
		real(8), dimension(N, 3), intent(in) :: r
		real(8), intent(in) :: L, cutoff
		real(8) :: d, f_ij
		real(8), dimension(3) :: d_r
		integer :: i, j, k
		integer, intent(in) :: N
		real(8), dimension(N, 3), intent(out) :: F
		real(8), intent(out) :: pot
		
		pot = 0.d0
		
		F = 0.d0
		
		do i = 1, N
			do j = i+1, N
				d_r(:) = r(i, :) - r(j, :)
				
				do while (any(d_r(:).gt.L/2.).or.(any(d_r(:).lt.(-L/2.))))
					call pbc(d_r, L, size(d_r))
				end do
				
				
				d = (d_r(1)**2+d_r(2)**2+d_r(3)**2)**(1.d0/2.d0)
				if (d.le.cutoff) then
					f_ij = 48.d0 / d**14 - 24.d0 / d**8
					F(i,:) = F(i,:) + f_ij*d_r(:)
					F(j,:) = F(j,:) - f_ij*d_r(:)
				
				
						if (isnan(F(i,1))) then
							print*, i, j
							stop
						end if
				
					pot = pot + 4.d0*( 1.d0/ d**12 - 1.d0 /d**6) - 4.d0*( 1/ cutoff**12 - 1.d0 /cutoff**6)
				
				end if 
			
			end do
		end do
	
	End Subroutine
\end{lstlisting}

\subsection{Pas de temps de Velocity Verlet}
\begin{lstlisting}
	Subroutine time_step_vVerlet(r, vel, pot, N, L, cutoff, dt)
		! """"
		! Calculates a timestep using the velicity verlet algorithm
		! INPUTS: r, vel, N, L, cutoff, dt
		! OUTPUT: r, vel, pot
		! """"
		Implicit none
		integer, intent(in) :: N
		real(8), dimension(N, 3), intent(inout) :: r, vel
		real(8), intent(in) :: dt, L, cutoff
		real(8), dimension(N, 3) :: F
		real(8), intent(out) ::  pot
		integer :: i
	
		Call find_force_LJ(r, N, L, cutoff, F, pot)
	
		do i = 1, N
			r(i, :) = r(i, :) + vel(i, :) * dt + 0.5*F(i, :)*dt*dt
	
			do while (any(r(i,:) > L/2.) .or. any(r(i,:) < -L/2.))
			! Apply periodic boundary conditions using the pbc subroutine
				call pbc(r(i,:), L, size(r(i,:)))
			end do
	
	
			vel(i, :) = vel(i, :) + F(i, :)* 0.5 * dt
		end do
	
		Call find_force_LJ(r, N, L, cutoff, F, pot)
	
		do i = 1, N
			vel(i, :) = vel(i, :) + F(i, :)* 0.5 * dt
		end do
	
	
	End Subroutine
\end{lstlisting}

\subsection{Energia cin√®tica}

\begin{lstlisting}
	
	Subroutine kinetic_energy(vel, K_energy, N)
		Implicit none
		integer, intent(in) :: N
		real(8), dimension(N, 3) :: vel
		integer :: i, k
		real(8) :: K_energy
		
		K_energy = 0
		! for each particle
		do i = 1, N
			! loop over coordinates
			do k = 1, 3
				K_energy = K_energy + 0.5*vel(i,k)*vel(i,k) 
			end do
		end do
	End Subroutine
\end{lstlisting}

\subsection{Temperatura instant√†nea}
	\begin{lstlisting}
	Function inst_temp(N, K_energy)
		Implicit none
		integer :: N, N_f
		real(8) :: K_energy, inst_temp
		
		N_f = 3*N - 3
		inst_temp = 2.d0/(N_f)*K_energy
		Return
	End Function
	\end{lstlisting}	
	

\subsection{Inicialitzaci√≥ de les velocitats}

\begin{lstlisting}

	Subroutine initialize_velocities(N, absV, vel)
	Implicit none
	integer, intent(in) :: N
	real(8) :: absV, rnd
	integer :: i, j
	real(8), dimension(N, 3) :: vel
	
	do i=1,N
		do j = 1,3
			call random_number(rnd)
			if (rnd.ge.0.5) then
				vel(i, j) = +absV
				else if (rnd.lt.0.5) then
				vel(i, j) = -absV
			end if
		end do
	end do
	
	
	End Subroutine
	
\end{lstlisting}

\subsection{C√†lcul del moment total del sistema}

\begin{lstlisting}

	Subroutine momentum(vel, p, N)
		Implicit none
		real(8), dimension(N, 3) :: vel
		real(8), dimension(3) :: total_p
		integer :: N, i
		real(8), intent(out) :: p 
		
		total_p(:) = 0
		
		! Accumulate p
		do i = 1,N
		total_p(:) = total_p(:) + vel(i, :)
		end do
		
		! Produce the module
		p = ( total_p(1)**2 + total_p(2)**2 + total_p(3)**2 )**(1./2.) 
	
	
	End Subroutine
\end{lstlisting}



\subsection{Pas de temps Euler}
\begin{lstlisting}
	Subroutine time_step_Euler_pbc(r_in, r_out, vel, N, L, cutoff, dt, pot)
		Implicit none
		integer, intent(in) :: N
		real(8), dimension(N, 3), intent(in) :: r_in
		real(8), dimension(N, 3), intent(out) :: r_out
		real(8), dimension(N, 3) :: vel, F
		real(8), intent(in) :: L, dt
		integer :: i, counter
		real(8) :: cutoff, pot
		
		Call find_force_LJ(r_in, N, L, cutoff, F, pot)
		
		
		do i = 1, N
			r_out(i, :) = r_in(i, :) + vel(i, :) * dt + 0.5*F(i, :)*dt*dt
			vel(i, :) = vel(i, :) + F(i, :) * dt
			
			do while (any(r_out(i,:).gt.L/2.).or.(any(r_out(i,:).lt.(-L/2.))))
				call pbc(r_out, L, size(r_out))
			end do
			
		
		end do
	
	End Subroutine
\end{lstlisting}

\subsection{Pressi√≥ instant√†nia}

\begin{lstlisting}
	Function W(N, r, rho, T, L, cutoff)
		Implicit none
		integer :: N, i, j, step
		real(8) :: suma, W, T, L, rho, d, cutoff, f_ij
		real(8), dimension(N,3) :: r
		real(8), dimension(3) :: r_ij
		
		suma = 0
		
		do i = 1, N
			do j = i+1, N
				r_ij(:) = r(i, :) - r(j, :)
				
				do while (any(r_ij(:).gt.L/2.).or.(any(r_ij(:).lt.(-L/2.))))
					call pbc(r_ij, L, size(r_ij))
				end do
				
				d = (r_ij(1)**2+r_ij(2)**2+r_ij(3)**2)**(1.d0/2.d0)
				
				if (d.le.cutoff) then
					f_ij = 48.d0 / d**13 - 24.d0 / d**7
					!	print*, "f", f_ij
					suma = suma + f_ij*d
				end if 
			
			end do
		end do
		
		! average = sum / (N*N)
		
		W = (1./3.)*suma
		
	
	end Function
	
\end{lstlisting}

\subsection{Despla√ßament quadr√†tic mitj√†}

\begin{lstlisting}
	Subroutine mean_sq_distance(r, r_0, N, MSD)
		Implicit none
		integer, intent(in) :: N
		real(8), dimension(N, 3), intent(in) :: r, r_0
		real(8), intent(out) :: MSD
		real(8) :: r_module, r_0_module
		integer :: i
		
		MSD = 0.d0
		
		do i = 1, N
			r_module = (r(i,1)**2 + r(i,2)**2 + r(i,3)**2)**2
			r_0_module =  (r_0(i,1)**2 + r_0(i,2)**2 + r_0(i,3)**2)**2
			MSD = MSD + (r_module - r_0_module)
		end do
		
		MSD = MSD/N
	
	End Subroutine
\end{lstlisting}



\subsection{Term√≤stat Andersen}

\begin{lstlisting}
	Subroutine therm_Andersen(vel, nu, sigma_gaussian, N)
		Implicit none
		integer :: i, N
		real(8) :: rand, nu, sigma_gaussian
		real(8), dimension(N, 3) :: vel
		real(8), dimension(2) :: xnums
		
		do i = 1, N
			call random_number(rand) 
				if (rand.lt.nu) then
					call BM(2, xnums, sigma_gaussian)
					!print*, "xnums: ", xnums
					vel(i, 1) = xnums(1)
					vel(i, 2) = xnums(2)
					call BM(2, xnums, sigma_gaussian)
					vel(i, 3) = xnums(1)
				end if
		end do
		!	print*, vel
	End Subroutine
\end{lstlisting}


\subsection{Box-M√ºller}

\begin{lstlisting}
	Subroutine BM(ndat,xnums,sigma)
		Implicit none
		Integer ::  ndat, i
		real(8), dimension(ndat) :: xnums
		real(8) :: r, phi, x1, x2, sigma
		real(8), parameter :: pi = 4.d0*atan(1.d0)
		
		Do i = 1, ndat, 2
			r = sqrt(-2.d0*log(1.d0-rand()))
			phi = 2.d0*pi*rand()
			x1 = r*cos(phi)
			x2 = r*sin(phi)
			if (i.ne.ndat) then ! Ens assegurem que no haguem acabat la llista
				xnums(i) = x1*sigma
				xnums(i+1) = x2*sigma
			endif
		end do
	return
	end Subroutine
	
\end{lstlisting}


\subsection{Processing code: compute average}

\begin{lstlisting}
import numpy as np
import os

# Function to calculate average and standard deviation for each column
def calculate_stats(data):
	averages = np.mean(data, axis=0)
	std_devs = np.std(data, axis=0)
	return averages, std_devs

# Read data from the file
file_path = os.environ.get("FILE")  # Replace with the actual path to your file
with open(file_path, 'r') as file:
	lines = file.readlines()

# Parse data from the lines
data = []
for line in lines:
	values = [float(val) for val in line.split()]
	data.append(values)

# Convert data to a NumPy array for easy calculations
data = np.array(data)

# Calculate averages and standard deviations
averages, std_devs = calculate_stats(data)

# Print the results
print(averages[0], std_devs[0], averages[1], std_devs[1], averages[2], std_devs[2], averages[3], std_devs[3], averages[4], std_devs[4])

\end{lstlisting}

\begin{lstlisting}
	#!/bin/bash
	
	for file in thermodynamics_*.dat; do
		echo "Processing file: $file"
		export FILE="$file"

		python3 compute_average.py >> results.dat
	done
	
\end{lstlisting}	

\begin{thebibliography}{100}
	\bibitem{StadPhys} Statistical Physics (2nd Edition), F. Mandl, Manchester Physics, John Wiley and Sons, 2008, ISBN 9780471915331
	\bibitem{vverlet} Swope, William C.; H. C. Andersen; P. H. Berens; K. R. Wilson (1 January 1982). "A computer simulation method for the calculation of equilibrium constants for the formation of physical clusters of molecules: Application to small water clusters". The Journal of Chemical Physics. 76 (1): 648 (Appendix).
	\bibitem{allen} Computer simulations of liquids, M.P. Allen and D.J. Tildesley, (Oxford Science Publications, 2000) 
	\bibitem{Hess} Hess, Siegfried. (1999). Augmented van der Waals equation of state for the Lennard-Jones fluid. Physica A: Statistical Mechanics and its Applications. 267. 58‚Äì70. 10.1016/S0378-4371(98)00670-0. 
	\bibitem{Gregory}: V. Paul Gregory, John C. Schug (1994): NPT Monte Carlo calculation of
	isotherms for the Lennard-Jones fluid, Molecular Physics: An International Journal at the Interface
	Between Chemistry and Physics, 82:4, 677-688
	\bibitem{HansenVerlet}  Hansen, J., and VerletT, L., Phase Transitions of the Lennard-Jones System, 1969, Phys. Rev., 184, 151

\end{thebibliography}


\end{document}